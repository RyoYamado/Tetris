# Система Мультиплеера для Тетриса

## Обзор

Реализована полнофункциональная система мультиплеера для игры Tetris, позволяющая играть 1v1 с друзьями в реальном времени через Firebase.

## Структура и компоненты

### Страницы (HTML)

#### 1. **menu.html** - Главное меню выбора режимов игры
- Отображается после входа пользователя вместо прямого перехода в игру
- Позволяет выбрать между:
  - Одиночной игрой
  - Мультиплеером 1v1
  - Таблицей лидеров
- Стилизована в соответствии с дизайном приложения

#### 2. **multiplayer.html** - Страница выбора мультиплеер режима
- Служит промежуточной страницей перед игрой
- Два главных режима:
  - **Создать комнату** - генерирует уникальный 8-символьный код для приглашения друзей
  - **Присоединиться к комнате** - позволяет присоединиться по коду комнаты
- Реальное время загрузки и обработки ошибок

#### 3. **multiplayer-game.html** - Игровая площадка мультиплеера
- Отображает две игровые доски рядом (Player 1 и Player 2)
- Реальное время синхронизации состояния игры
- Отображение статистики обоих игроков:
  - Очки (Score)
  - Уровень (Level)
  - Собранные линии (Lines)
  - Статус жизни

### JavaScript модули

#### 1. **multiplayer-room.js** - Управление комнатами
```javascript
export class MultiplayerRoomManager
```

**Основные методы:**
- `generateRoomCode()` - генерирует случайный 8-символьный код комнаты
- `createRoom(userId, userName)` - создает новую комнату и добавляет создателя как player1
- `joinRoom(roomCode, userId, userName)` - присоединяет второго игрока к существующей комнате
- `onRoomChange(roomCode, callback)` - слушает изменения комнаты в реальном времени
- `updatePlayerStatus(roomCode, playerId, status)` - обновляет статус игрока (очки, уровень, жив/мертв)
- `updateGameState(roomCode, gameState)` - обновляет состояние игры (статус, время начала/конца)
- `leaveRoom(roomCode)` - удаляет комнату и прекращает слушание изменений

**Структура данных в Firebase:**
```javascript
{
  code: "ABCD1234",
  createdBy: "userId1",
  status: "waiting|playing|finished",
  player1: {
    id: "userId1",
    name: "Player Name",
    joined: true,
    ready: false,
    score: 0,
    level: 1,
    lines: 0,
    alive: true
  },
  player2: {
    id: "userId2",
    name: "Player Name",
    joined: true,
    ready: false,
    score: 0,
    level: 1,
    lines: 0,
    alive: true
  },
  createdAt: "2025-11-27T...",
  expiresAt: "2025-11-27T..." // 30 минут
}
```

#### 2. **multiplayer-game-manager.js** - Синхронизация игрового состояния
```javascript
export class MultiplayerGameManager
```

**Основные методы:**
- `startSync()` - запускает синхронизацию состояния каждые 100ms
- `stopSync()` - останавливает синхронизацию
- `syncGameState()` - отправляет текущее состояние игры локального игрока в Firebase
- `updateOpponentDisplay(opponentData)` - обновляет отображение статистики противника
- `getWinner(player1Data, player2Data)` - определяет победителя по очкам
- `formatResultMessage(result, player1Name, player2Name)` - форматирует сообщение о результате

**Особенности:**
- Синхронизация происходит каждые 100ms для оптимального баланса между реактивностью и нагрузкой
- Автоматически отслеживает когда игрок "выбывает" из игры (gameover)
- Реальное время обновление статистики обоих игроков

#### 3. **multiplayer-page.js** - Логика страницы выбора режима
```javascript
class MultiplayerPage
```

**Функциональность:**
- Управление переключением между режимами (выбор режима ↔ меню мультиплеера)
- Создание новой комнаты с перенаправлением
- Присоединение к существующей комнате с валидацией кода
- Обработка ошибок и отображение сообщений
- Автоматическое преобразование кода в UPPERCASE при вводе

#### 4. **multiplayer-game-page.js** - Основная логика мультиплеер игры
```javascript
class MultiplayerGamePage
```

**Основные функции:**
- Инициализация игр обоих игроков на одной странице
- Установка слушателей в реальном времени для отслеживания изменений комнаты
- Обработка начала игры (синхронизированный старт)
- Обработка конца игры и определение победителя
- Отслеживание отключения противника и показ соответствующего модального окна
- Переиспользование существующего движка TetrisGame

#### 5. **menu-page.js** - Логика главного меню
```javascript
class MenuPage
```

**Функциональность:**
- Перенаправление на нужную страницу (игра, мультиплеер, таблица лидеров)
- Обновление информации пользователя
- Обработка выхода из аккаунта

### CSS файлы

#### 1. **css/multiplayer.css** - Стили страницы выбора мультиплеера
- Карточки игровых режимов с анимациями
- Формы создания/присоединения к комнате
- Модальное окно загрузки с спиннером
- Адаптивный дизайн для всех экранов

#### 2. **css/multiplayer-game.css** - Стили игровой страницы мультиплеера
- Два игровых поля рядом (Grid layout)
- Статистика игроков в реальном времени
- Модальные окна для Game Over, потери соединения, загрузки
- Анимированный разделитель "VS" между игроками
- Полная адаптивность (вертикальный макет на мобильных)

#### 3. **css/menu.css** - Стили главного меню
- Карточки режимов с hover эффектами
- Плавные переходы и анимации
- Информация о пользователе в заголовке
- Адаптивный дизайн

## Поток работы

### Создание комнаты и приглашение друга

1. **Пользователь 1:**
   - Переходит на menu.html
   - Нажимает "Мультиплеер"
   - Нажимает "Создать комнату"
   - Получает уникальный код (например: "ABCD1234")
   - Переходит на multiplayer-game.html в режиме ожидания (isHost=true)

2. **Пользователь 2:**
   - Получает код "ABCD1234" от друга
   - Переходит на menu.html
   - Нажимает "Мультиплеер"
   - Вводит код "ABCD1234"
   - Нажимает "Присоединиться"
   - Переходит на multiplayer-game.html (isHost=false)

3. **Обе стороны:**
   - Видят информацию друг друга
   - Видят "✓ Готов" статус
   - Могут нажать кнопку "Начать игру"
   - Игра стартует синхронно
   - В реальном времени видят статистику противника

### Во время игры

- Каждые 100ms синхронизируется:
  - Текущий счет (score)
  - Уровень сложности (level)
  - Количество собранных линий (lines)
  - Статус "жив/мертв" (alive)

- Если один игрок "выбывает":
  - Его статус обновляется в Firebase
  - Второй игрок видит это немедленно
  - Если оба выбыли - показывается экран Game Over с результатом

### Определение победителя

- **Победитель** = игрок с большим количеством очков
- Если очки равны = **Ничья**
- Результат отображается в модальном окне с подробной статистикой

## Интеграция с существующим кодом

### Модификация game.html
Добавлена кнопка навигации "Мультиплеер" в заголовок, позволяющая быстро переключаться между одиночной игрой и мультиплеером.

### Модификация game-page.js
Добавлен обработчик для кнопки "multiplayerButton", перенаправляющий на multiplayer.html.

### Модификация auth-page.js
Изменено перенаправление с game.html на menu.html для показа меню выбора режима.

## Безопасность

### Firebase Rules
Рекомендуется установить следующие правила для базы данных:
```json
{
  "rules": {
    "multiplayer_rooms": {
      "$roomCode": {
        ".read": true,
        ".write": "root.child('createdBy').val() === auth.uid || root.child('player1').child('id').val() === auth.uid || root.child('player2').child('id').val() === auth.uid",
        ".validate": "newData.hasChildren(['code', 'createdBy', 'player1'])"
      }
    }
  }
}
```

## Обработка ошибок

1. **Комната не найдена** - если пользователь вводит неправильный код
2. **Игра уже началась** - если присоединение происходит после начала игры
3. **В комнате уже 2 игрока** - если пытаются присоединиться третьему
4. **Потеря соединения** - показывается модальное окно с предложением вернуться в меню
5. **Противник отключился** - комната удаляется, показывается сообщение

## Тестирование

### Основные сценарии:
1. ✓ Создание комнаты и приглашение друга по коду
2. ✓ Присоединение к существующей комнате
3. ✓ Синхронизация игрового состояния в реальном времени
4. ✓ Определение победителя по очкам
5. ✓ Обработка отключения одного из игроков
6. ✓ Переиграть матч
7. ✓ Вернуться в меню

## Возможные улучшения в будущем

1. **Чат между игроками** - добавить функцию обмена сообщениями
2. **Система приглашений** - список друзей и прямые приглашения
3. **Рейтинг мультиплеера** - отдельная таблица лидеров для 1v1
4. **Режимы игры** - классический, за время, очки/линии
5. **Статистика матчей** - история игр и аналитика
6. **Турниры** - поддержка организации турниров между игроками
7. **Спектаторы** - возможность наблюдать за игрой других
8. **Аудио-чат** - встроенная голосовая коммуникация
9. **Мобильное приложение** - нативные приложения для iOS/Android
10. **AI противник** - умный компьютерный противник с разными уровнями сложности

## Заключение

Система мультиплеера полностью интегрирована с существующим приложением Tetris и готова к использованию. Все компоненты работают синхронно в реальном времени благодаря Firebase Realtime Database.
