# Система Таблицы Лидеров

## Обзор

Полная система управления таблицей лидеров для игры Тетрис с использованием Firebase. Система позволяет отслеживать результаты игроков, их рейтинги и статистику.

## Компоненты системы

### 1. LeaderboardManager (`js/leaderboard.js`)

Основной класс для управления данными лидеров и статистикой.

#### Методы:

- **`getTopPlayers(limit_count = 10)`** - Получить топ игроков
  - Кэширует результаты на 30 секунд
  - Возвращает массив объектов игроков

- **`getUserStats(userId)`** - Получить статистику конкретного игрока
  - Включает ранг и все данные пользователя
  - Кэширует результаты на 10 секунд

- **`getNearbyPlayers(userId)`** - Получить игроков рядом с указанным
  - Возвращает ±5 игроков относительно текущего ранга

- **`searchPlayers(searchTerm, maxResults = 10)`** - Поиск игроков по имени
  - Поиск по частичному совпадению (регистронезависимый)
  - Возвращает до maxResults результатов

- **`getPlayerProfile(userId)`** - Получить профиль игрока
  - Полная информация об игроке и его рейтинге

- **`getLeaderboardStats()`** - Получить общую статистику
  - Общее количество игроков
  - Сумма всех очков
  - Максимальный результат
  - Средний результат

#### Кэширование:

- Top Players: 30 секунд
- User Stats: 10 секунд
- Метод `clearCache()` очищает весь кэш
- Метод `forceUpdate()` принудительно обновляет кэш

### 2. Страница Лидеров (`leaderboard.html`)

Основная страница для просмотра таблицы лидеров.

#### Функциональность:

- **Фильтры:**
  - Топ 10 - 10 лучших игроков
  - Около меня - игроки рядом с текущим пользователем
  - Все игроки - полный список всех игроков

- **Поиск:**
  - Поиск игроков по имени
  - Real-time результаты

- **Отображение статистики:**
  - Личный рейтинг
  - Личный лучший результат
  - Среднее значение очков
  - Общая статистика сервера

- **Таблица лидеров:**
  - Позиция в рейтинге
  - Имя игрока
  - Лучший результат
  - Количество сыгранных игр
  - Средний результат на игру
  - Выделение текущего пользователя

### 3. LeaderboardPage (`js/leaderboard-page.js`)

Контроллер страницы лидеров.

#### Функции:

- Управление фильтрами
- Обработка поиска
- Загрузка и отображение данных
- Обновление UI
- Навигация

### 4. Стили (`css/leaderboard.css`)

Полная стилизация страницы лидеров:
- Адаптивный дизайн
- Анимации
- Поддержка мобильных устройств
- Темная тема с акцентами

## Структура данных Firebase

### Коллекция `users`

Каждый документ содержит:

```javascript
{
    username: string,           // Имя пользователя
    bestScore: number,          // Лучший результат
    gamesPlayed: number,        // Количество игр
    createdAt: timestamp,       // Дата регистрации
    lastPlayed: timestamp       // Последняя игра
}
```

## Интеграция с игровой страницей

### Добавлена кнопка "Таблица лидеров" в game.html

Пользователи могут перейти на страницу лидеров непосредственно из игровой страницы:

```html
<button id="leaderboardButton" class="nav-button">Таблица лидеров</button>
```

### Обработчик события в game-page.js:

```javascript
const leaderboardButton = document.getElementById('leaderboardButton');
if (leaderboardButton) {
    leaderboardButton.addEventListener('click', () => {
        window.location.href = 'leaderboard.html';
    });
}
```

## Автоматическое обновление рейтинга

При завершении игры:

1. Результат сохраняется через `AuthManager.saveScore(score)`
2. Обновляется `bestScore` (если новый результат выше)
3. Увеличивается счетчик `gamesPlayed`
4. Устанавливается `lastPlayed` с текущим временем

## Использование API

### Получение топ 10:

```javascript
const leaderboardManager = new LeaderboardManager(authManager);
const topPlayers = await leaderboardManager.getTopPlayers(10);
```

### Получение статистики пользователя:

```javascript
const userStats = await leaderboardManager.getUserStats(userId);
console.log(`Ранг: ${userStats.rank}, Очки: ${userStats.bestScore}`);
```

### Поиск игроков:

```javascript
const results = await leaderboardManager.searchPlayers("John", 20);
```

### Получение общей статистики:

```javascript
const stats = await leaderboardManager.getLeaderboardStats();
console.log(`Всего игроков: ${stats.totalPlayers}`);
console.log(`Средний результат: ${stats.averageScore}`);
```

## Безопасность

- **XSS Protection**: Все пользовательские данные экранируются перед отображением
- **Firebase Security**: Используются правила Firebase для защиты данных
- **Authentication**: Требуется авторизация для доступа к странице

## Производительность

- **Кэширование**: Результаты кэшируются для снижения нагрузки на БД
- **Пагинация**: Таблица лидеров использует прокрутку вместо полной загрузки
- **Оптимизация DOM**: Использование DocumentFragment для добавления элементов

## Адаптивность

Страница полностью адаптивна:
- Desktop версия: 5 колонок в таблице
- Tablet (1024px): 3 колонки
- Mobile (768px): 3 колонки с меньшим размером
- Small mobile (480px): 2 колонки

## Будущие улучшения

- Фильтрация по времени (за день, неделю, месяц)
- Достижения и бейджи
- Система друзей
- История игр
- Экспорт данных
- Сравнение результатов
